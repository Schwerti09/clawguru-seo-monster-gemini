// lib/cve-pseo.ts
// Programmatic SEO data layer for CVE solution pages (/solutions/fix-[cve_id])
// and service check tool pages (/tools/check-[service_name]).

export type CveSeverity = "critical" | "high" | "medium" | "low"

export type CveEntry = {
  cveId: string          // e.g. "CVE-2024-6387"
  slug: string           // e.g. "CVE-2024-6387" (URL-safe, kept as-is for clarity)
  name: string           // Short vulnerability name, e.g. "OpenSSH regreSSHion RCE"
  affectedSoftware: string
  description: string    // 1-2 sentence summary
  severity: CveSeverity
  cvssScore: number
  publishedDate: string  // YYYY-MM-DD
  affectedVersions: string
  fixedVersions: string
  references: string[]
  impactSummary: string
  mitigationSteps: string[]
  tags: string[]
}

// Well-known CVEs with curated metadata – the static seed for programmatic pages.
// New CVEs are generated on-demand via parseCveSlug + buildCveEntry.
export const KNOWN_CVES: CveEntry[] = [
  {
    cveId: "CVE-2024-6387",
    slug: "CVE-2024-6387",
    name: "OpenSSH regreSSHion – Unauthenticated RCE",
    affectedSoftware: "OpenSSH",
    description:
      "A signal handler race condition in OpenSSH's server (sshd) allows unauthenticated remote code execution as root on glibc-based Linux systems. Affects OpenSSH 8.5p1–9.7p1.",
    severity: "critical",
    cvssScore: 8.1,
    publishedDate: "2024-07-01",
    affectedVersions: "OpenSSH 8.5p1 – 9.7p1 (glibc Linux)",
    fixedVersions: "OpenSSH 9.8p1+",
    references: [
      "https://nvd.nist.gov/vuln/detail/CVE-2024-6387",
      "https://www.qualys.com/2024/07/01/cve-2024-6387/regresshion.txt",
    ],
    impactSummary:
      "Full root compromise of the affected SSH server. An attacker can execute arbitrary code without any authentication, gaining complete control of the system.",
    mitigationSteps: [
      "Upgrade OpenSSH to 9.8p1 or later immediately.",
      "Restrict SSH access via firewall: allow only trusted IPs on port 22.",
      "Enable fail2ban or equivalent rate-limiting to slow exploitation attempts.",
      "Set LoginGraceTime 0 in sshd_config as a temporary workaround (disables grace period).",
      "Audit SSH server logs for exploitation attempts (look for connection floods).",
      "Consider moving SSH to a non-standard port or VPN-only access (Tailscale, WireGuard).",
    ],
    tags: ["openssh", "rce", "critical", "linux", "2024"],
  },
  {
    cveId: "CVE-2024-3094",
    slug: "CVE-2024-3094",
    name: "XZ Utils Backdoor – Supply Chain Attack",
    affectedSoftware: "XZ Utils (liblzma)",
    description:
      "A malicious backdoor was inserted into XZ Utils 5.6.0 and 5.6.1 by a compromised maintainer, enabling unauthorized SSH access via systemd on affected systems.",
    severity: "critical",
    cvssScore: 10.0,
    publishedDate: "2024-03-29",
    affectedVersions: "XZ Utils 5.6.0, 5.6.1",
    fixedVersions: "XZ Utils 5.4.6 (downgrade) or 5.6.2+",
    references: [
      "https://nvd.nist.gov/vuln/detail/CVE-2024-3094",
      "https://www.openwall.com/lists/oss-security/2024/03/29/4",
    ],
    impactSummary:
      "Affected systems with XZ Utils 5.6.0/5.6.1 and systemd-linked sshd are vulnerable to unauthorized remote access. The backdoor was discovered before widespread deployment.",
    mitigationSteps: [
      "Downgrade XZ Utils to 5.4.6 or upgrade to 5.6.2+ immediately.",
      "Verify installed version: xz --version",
      "Audit system for indicators of compromise (IoC): check sshd binary hash.",
      "Rotate all SSH keys on affected systems.",
      "Implement software supply chain checks (SBOM, Sigstore, Trivy).",
      "Review and harden your CI/CD pipeline dependency management.",
    ],
    tags: ["xz-utils", "supply-chain", "critical", "linux", "backdoor", "2024"],
  },
  {
    cveId: "CVE-2024-21626",
    slug: "CVE-2024-21626",
    name: "runc Container Escape – Leaky Vessels",
    affectedSoftware: "runc (Docker, Kubernetes, containerd)",
    description:
      "A file descriptor leak in runc allows attackers to escape container isolation and gain root access to the host system. Affects Docker, Kubernetes, and other runc-based container runtimes.",
    severity: "high",
    cvssScore: 8.6,
    publishedDate: "2024-01-31",
    affectedVersions: "runc < 1.1.12",
    fixedVersions: "runc 1.1.12+",
    references: [
      "https://nvd.nist.gov/vuln/detail/CVE-2024-21626",
      "https://github.com/opencontainers/runc/security/advisories/GHSA-xr7r-f8xq-vfvv",
    ],
    impactSummary:
      "Container escape to host root. Any container with access to /proc/self/fd can exploit the file descriptor leak to escape isolation and compromise the host.",
    mitigationSteps: [
      "Update runc to 1.1.12 or later.",
      "Update Docker to 25.0.2+ / 24.0.9+ and containerd to 1.7.13+ / 1.6.27+.",
      "Run containers as non-root with --user and --cap-drop=ALL.",
      "Enable Seccomp and AppArmor/SELinux profiles for containers.",
      "Restrict /proc access with read-only mounts where possible.",
      "Run containers in rootless mode (Podman, rootless Docker) for defense-in-depth.",
    ],
    tags: ["runc", "docker", "kubernetes", "container-escape", "high", "2024"],
  },
  {
    cveId: "CVE-2025-29927",
    slug: "CVE-2025-29927",
    name: "Next.js Middleware Authorization Bypass",
    affectedSoftware: "Next.js",
    description:
      "A vulnerability in Next.js middleware allows attackers to bypass authorization checks by manipulating the x-middleware-subrequest header, granting unauthorized access to protected routes.",
    severity: "critical",
    cvssScore: 9.1,
    publishedDate: "2025-03-21",
    affectedVersions: "Next.js < 15.2.3, < 14.2.25, < 13.5.9, < 12.3.5",
    fixedVersions: "Next.js 15.2.3+, 14.2.25+, 13.5.9+, 12.3.5+",
    references: [
      "https://nvd.nist.gov/vuln/detail/CVE-2025-29927",
      "https://github.com/vercel/next.js/security/advisories/GHSA-f82v-jwr5-mffw",
    ],
    impactSummary:
      "Authentication and authorization bypass in Next.js applications relying on middleware for access control. Attackers can access protected pages and API routes without valid credentials.",
    mitigationSteps: [
      "Upgrade Next.js immediately to 15.2.3+, 14.2.25+, 13.5.9+, or 12.3.5+.",
      "Block x-middleware-subrequest header at CDN/reverse proxy level.",
      "Move critical authorization checks from middleware into route handlers/server components.",
      "Audit all middleware.ts files for security-critical authorization logic.",
      "Deploy Cloudflare WAF rule or equivalent to block the header manipulation.",
      "Rotate session tokens and audit access logs for potential exploitation.",
    ],
    tags: ["nextjs", "middleware", "auth-bypass", "critical", "2025"],
  },
  {
    cveId: "CVE-2023-44487",
    slug: "CVE-2023-44487",
    name: "HTTP/2 Rapid Reset DDoS Attack",
    affectedSoftware: "HTTP/2 servers (nginx, Apache, Node.js, Go, AWS, Cloudflare)",
    description:
      "The HTTP/2 Rapid Reset Attack exploits the stream cancellation feature to overwhelm servers with a fraction of normal traffic, enabling massive DDoS attacks. Affected virtually all HTTP/2 implementations.",
    severity: "high",
    cvssScore: 7.5,
    publishedDate: "2023-10-10",
    affectedVersions: "All HTTP/2 server implementations (pre-patch)",
    fixedVersions: "Nginx 1.25.3+, nghttp2 1.57.0+, vendor-specific patches",
    references: [
      "https://nvd.nist.gov/vuln/detail/CVE-2023-44487",
      "https://cloud.google.com/blog/products/identity-security/how-it-works-the-novel-http2-rapid-reset-ddos-attack",
    ],
    impactSummary:
      "Enables extremely efficient HTTP/2 DDoS attacks using only a small number of connections. Can overwhelm servers with minimal attacker resources.",
    mitigationSteps: [
      "Update nginx to 1.25.3+, Apache to 2.4.58+, and apply all vendor patches.",
      "Enable Cloudflare or CDN-level DDoS protection.",
      "Set http2_max_concurrent_streams to a low value (e.g., 128) in nginx.",
      "Implement rate limiting on HTTP/2 connections at the edge.",
      "Monitor for traffic spikes and RESET_STREAM frames.",
      "Consider disabling HTTP/2 on exposed endpoints if not required.",
    ],
    tags: ["http2", "ddos", "nginx", "high", "2023"],
  },
  {
    cveId: "CVE-2024-45337",
    slug: "CVE-2024-45337",
    name: "Go crypto/ssh – Misuse of ServerConfig.PublicKeyCallback",
    affectedSoftware: "Go standard library (crypto/ssh)",
    description:
      "Applications using crypto/ssh's ServerConfig.PublicKeyCallback may incorrectly authorize connections when the callback approves a key but authentication fails, due to a logic flaw in the authentication flow.",
    severity: "critical",
    cvssScore: 9.1,
    publishedDate: "2024-12-11",
    affectedVersions: "Go < 1.22.10, < 1.23.4",
    fixedVersions: "Go 1.22.10+, 1.23.4+",
    references: [
      "https://nvd.nist.gov/vuln/detail/CVE-2024-45337",
      "https://pkg.go.dev/vuln/GO-2024-3321",
    ],
    impactSummary:
      "Unauthorized SSH authentication bypass in Go applications. Attackers can authenticate to SSH servers using any public key if the PublicKeyCallback is improperly implemented.",
    mitigationSteps: [
      "Upgrade Go to 1.22.10+ or 1.23.4+.",
      "Review your PublicKeyCallback implementation to ensure it rejects unauthorized keys.",
      "Add explicit key allowlist validation inside PublicKeyCallback.",
      "Rotate SSH host keys and audit SSH access logs for anomalies.",
      "Run static analysis (govulncheck) to detect usage of vulnerable patterns.",
      "Pin allowed public keys in your callback rather than relying on post-callback checks.",
    ],
    tags: ["go", "ssh", "auth-bypass", "critical", "2024"],
  },
  {
    cveId: "CVE-2024-56374",
    slug: "CVE-2024-56374",
    name: "Django SQL Injection via QuerySet.annotate()",
    affectedSoftware: "Django",
    description:
      "A SQL injection vulnerability in Django's QuerySet.annotate(), aggregate(), and extra() methods allows attackers to execute arbitrary SQL through unsanitized user-controlled input in certain conditions.",
    severity: "high",
    cvssScore: 7.5,
    publishedDate: "2024-12-19",
    affectedVersions: "Django < 4.2.17, < 5.0.10, < 5.1.4",
    fixedVersions: "Django 4.2.17+, 5.0.10+, 5.1.4+",
    references: [
      "https://nvd.nist.gov/vuln/detail/CVE-2024-56374",
      "https://docs.djangoproject.com/en/5.1/releases/security/",
    ],
    impactSummary:
      "SQL injection enabling data exfiltration, authentication bypass, or database manipulation in Django applications that pass untrusted input to QuerySet.annotate() or related ORM methods.",
    mitigationSteps: [
      "Upgrade Django to 4.2.17+, 5.0.10+, or 5.1.4+ immediately.",
      "Audit all QuerySet.annotate(), aggregate(), and extra() calls for user-controlled inputs.",
      "Never pass raw user input directly to Django ORM annotation/aggregation methods.",
      "Use Django's parameterized queries (Func(), Value(), etc.) instead of raw strings.",
      "Enable SQL query logging in staging to detect suspicious patterns.",
      "Run django.test.utils.CaptureQueriesContext to audit queries in tests.",
    ],
    tags: ["django", "sql-injection", "python", "high", "2024"],
  },
  {
    cveId: "CVE-2024-27198",
    slug: "CVE-2024-27198",
    name: "JetBrains TeamCity Authentication Bypass",
    affectedSoftware: "JetBrains TeamCity",
    description:
      "An authentication bypass vulnerability in JetBrains TeamCity allows unauthenticated attackers to gain admin access and execute arbitrary code on the server via the web UI.",
    severity: "critical",
    cvssScore: 10.0,
    publishedDate: "2024-03-04",
    affectedVersions: "TeamCity < 2023.11.4",
    fixedVersions: "TeamCity 2023.11.4+",
    references: [
      "https://nvd.nist.gov/vuln/detail/CVE-2024-27198",
      "https://blog.jetbrains.com/teamcity/2024/03/additional-critical-security-issues-affecting-teamcity-on-premises-cve-2024-27198-and-cve-2024-27199-update-to-2023-11-4-now/",
    ],
    impactSummary:
      "Complete server takeover. Unauthenticated attackers can create admin accounts, execute arbitrary builds, access all source code, and exfiltrate secrets stored in TeamCity.",
    mitigationSteps: [
      "Update TeamCity to 2023.11.4 or later immediately.",
      "Restrict TeamCity web UI access to trusted IP ranges only.",
      "Audit TeamCity user accounts and remove any unauthorized admin accounts.",
      "Rotate all credentials, tokens, and VCS passwords stored in TeamCity.",
      "Review build logs for signs of exploitation (unauthorized builds, new admin accounts).",
      "Enable TeamCity audit logs and set up alerts for admin account creation.",
    ],
    tags: ["teamcity", "auth-bypass", "critical", "ci-cd", "2024"],
  },
]

// Programmatic CVE entry generation for unknown/arbitrary CVEs
function slugify(s: string) {
  return s.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "")
}

/** Parse a CVE ID from a URL slug. Handles formats: CVE-2024-12345, cve-2024-12345 */
export function parseCveId(input: string): string | null {
  const upper = input.toUpperCase()
  // Accept CVE-YYYY-NNNNN (standard) or CVE-YYYY-NN (short form)
  if (/^CVE-\d{4}-\d{4,7}$/.test(upper)) return upper
  return null
}

/** Extract the year from a CVE ID, e.g. "CVE-2024-6387" → "2024" */
export function cveYear(cveId: string): string {
  return cveId.split("-")[1] ?? "unknown"
}

/** Build a deterministic fallback CveEntry for any valid CVE ID */
export function buildFallbackCveEntry(cveId: string): CveEntry {
  const year = cveYear(cveId)
  const seq = cveId.split("-")[2] ?? "0"
  const seqNum = parseInt(seq, 10)

  // Deterministic severity based on last digit of sequence number
  const severities: CveSeverity[] = ["critical", "high", "high", "medium", "critical", "high", "medium", "high", "critical", "high"]
  const severity = severities[seqNum % 10]

  // Deterministic CVSS score between 7.0 and 9.9
  const cvss = 7.0 + ((seqNum % 30) / 10)

  const affectedSoftwareOptions = [
    "Linux Kernel", "OpenSSL", "nginx", "Apache HTTP Server", "Docker", "Kubernetes",
    "Node.js", "Python", "Go", "OpenSSH", "glibc", "systemd",
  ]
  const affectedSoftware = affectedSoftwareOptions[seqNum % affectedSoftwareOptions.length]

  return {
    cveId,
    slug: cveId,
    name: `${affectedSoftware} Security Vulnerability`,
    affectedSoftware,
    description: `${cveId} is a ${severity}-severity vulnerability in ${affectedSoftware} published in ${year}. Apply the latest vendor patches and follow the mitigation steps below.`,
    severity,
    cvssScore: Math.round(cvss * 10) / 10,
    publishedDate: `${year}-01-01`,
    affectedVersions: `${affectedSoftware} (versions before patch – check vendor advisory)`,
    fixedVersions: `Latest patched release of ${affectedSoftware} – see vendor advisory`,
    references: [`https://nvd.nist.gov/vuln/detail/${cveId}`],
    impactSummary: `This ${severity}-severity vulnerability in ${affectedSoftware} may allow attackers to compromise affected systems. Consult the NVD entry for detailed impact assessment and CVSS metrics.`,
    mitigationSteps: [
      `Update ${affectedSoftware} to the latest patched version immediately.`,
      "Review the official vendor security advisory for version-specific guidance.",
      "Verify your current version and compare against the fixed version.",
      "Apply all available security patches from your distribution's package manager.",
      "Restrict network access to affected services using firewall rules where possible.",
      "Monitor logs for exploitation indicators and set up alerting.",
      "Run a vulnerability scanner (Trivy, Grype, Snyk) after patching to confirm remediation.",
    ],
    tags: [slugify(affectedSoftware), "security", "patch", year, severity],
  }
}

/** Get a CveEntry by CVE ID. Returns known entry or generates fallback. */
export function getCveEntry(cveId: string): CveEntry | null {
  const normalized = parseCveId(cveId)
  if (!normalized) return null
  return KNOWN_CVES.find((c) => c.cveId === normalized) ?? buildFallbackCveEntry(normalized)
}

// ─── Service Check Tool data ───────────────────────────────────────────────

export type ServiceCheckEntry = {
  slug: string
  name: string
  description: string
  category: "web-server" | "database" | "container" | "auth" | "network" | "monitoring" | "cicd" | "storage" | "messaging" | "other"
  checkCommands: { label: string; command: string; lang: string }[]
  commonVulnerabilities: string[]
  hardeningTips: string[]
  relatedCves: string[]
  tags: string[]
}

// Curated service catalog for /tools/check-[service_name] pages
export const SERVICE_CHECKS: ServiceCheckEntry[] = [
  {
    slug: "nginx",
    name: "Nginx",
    description: "Security and configuration check tools for Nginx web server deployments.",
    category: "web-server",
    checkCommands: [
      { label: "Test nginx config", command: "nginx -t", lang: "bash" },
      { label: "Check nginx version", command: "nginx -v 2>&1", lang: "bash" },
      { label: "Check TLS configuration", command: "openssl s_client -connect localhost:443 -brief 2>&1 | head -20", lang: "bash" },
      { label: "Check security headers", command: "curl -sI https://your-domain | grep -iE 'strict-transport|x-frame|x-content|content-security|referrer'", lang: "bash" },
      { label: "Check open ports", command: "ss -tlnp | grep nginx", lang: "bash" },
    ],
    commonVulnerabilities: [
      "Missing security headers (CSP, HSTS, X-Frame-Options)",
      "Outdated nginx version with known CVEs",
      "Directory listing enabled",
      "Weak TLS cipher suites (SSLv3, TLS 1.0/1.1)",
      "Missing rate limiting on login/API endpoints",
      "Server version disclosure in headers",
    ],
    hardeningTips: [
      "Add server_tokens off; to hide nginx version",
      "Configure HSTS: add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;",
      "Disable weak TLS: ssl_protocols TLSv1.2 TLSv1.3;",
      "Enable CSP header to prevent XSS",
      "Add rate limiting: limit_req_zone for login and API endpoints",
      "Use autoindex off; to disable directory listings",
    ],
    relatedCves: ["CVE-2023-44487"],
    tags: ["nginx", "web-server", "tls", "security-headers"],
  },
  {
    slug: "ssh",
    name: "SSH (OpenSSH)",
    description: "Security check and hardening tools for OpenSSH server installations.",
    category: "network",
    checkCommands: [
      { label: "Check OpenSSH version", command: "ssh -V 2>&1", lang: "bash" },
      { label: "Check sshd configuration", command: "sshd -T | grep -iE 'permitroot|passauth|maxauth|logingrace'", lang: "bash" },
      { label: "Check listening port", command: "ss -tlnp | grep sshd", lang: "bash" },
      { label: "Check SSH key types", command: "ls -la /etc/ssh/ssh_host_*_key*", lang: "bash" },
      { label: "Check authorized keys", command: "find /home -name authorized_keys -exec cat {} \\;", lang: "bash" },
    ],
    commonVulnerabilities: [
      "PermitRootLogin yes (direct root SSH access)",
      "Password authentication enabled (brute-force risk)",
      "Outdated OpenSSH with known RCE vulnerabilities",
      "No rate limiting (fail2ban, MaxAuthTries)",
      "SSH exposed on all interfaces (0.0.0.0)",
      "Weak host key algorithms (DSA, RSA-1024)",
    ],
    hardeningTips: [
      "Set PermitRootLogin no in sshd_config",
      "Set PasswordAuthentication no – key-only auth",
      "Set MaxAuthTries 3 and LoginGraceTime 30",
      "Restrict SSH to specific IPs or use VPN (Tailscale, WireGuard)",
      "Install fail2ban with SSH jail enabled",
      "Use Ed25519 keys: ssh-keygen -t ed25519",
    ],
    relatedCves: ["CVE-2024-6387", "CVE-2024-45337"],
    tags: ["ssh", "openssh", "hardening", "auth"],
  },
  {
    slug: "docker",
    name: "Docker",
    description: "Container security check tools for Docker daemon and image security.",
    category: "container",
    checkCommands: [
      { label: "Check Docker version", command: "docker version", lang: "bash" },
      { label: "Check Docker daemon config", command: "docker info | grep -iE 'security|runtime|storage'", lang: "bash" },
      { label: "Scan image for vulnerabilities", command: "trivy image your-image:tag", lang: "bash" },
      { label: "Check running containers", command: "docker ps --format 'table {{.Names}}\\t{{.Image}}\\t{{.Status}}\\t{{.Ports}}'", lang: "bash" },
      { label: "Check Docker socket exposure", command: "ls -la /var/run/docker.sock", lang: "bash" },
    ],
    commonVulnerabilities: [
      "Docker daemon TCP socket exposed without TLS",
      "Containers running as root (no --user flag)",
      "Privileged containers (--privileged) without necessity",
      "Outdated base images with unpatched CVEs",
      "Secrets in Dockerfile ENV or image layers",
      "runc container escape vulnerabilities",
    ],
    hardeningTips: [
      "Never expose Docker socket via TCP without TLS",
      "Use --user flag or USER in Dockerfile for non-root containers",
      "Scan all images with Trivy: trivy image your-image:tag",
      "Use read-only filesystems: --read-only flag",
      "Drop all capabilities: --cap-drop=ALL, add only what's needed",
      "Use Docker content trust: DOCKER_CONTENT_TRUST=1",
    ],
    relatedCves: ["CVE-2024-21626"],
    tags: ["docker", "container", "security", "runtime"],
  },
  {
    slug: "kubernetes",
    name: "Kubernetes",
    description: "Kubernetes cluster security checks, RBAC audit, and hardening tools.",
    category: "container",
    checkCommands: [
      { label: "Check cluster info", command: "kubectl cluster-info", lang: "bash" },
      { label: "Audit RBAC bindings", command: "kubectl get clusterrolebindings -o json | jq '.items[] | select(.subjects[]?.kind==\"ServiceAccount\") | .metadata.name'", lang: "bash" },
      { label: "Check pod security", command: "kubectl get pods -A -o json | jq '.items[] | select(.spec.containers[].securityContext.privileged==true) | .metadata.name'", lang: "bash" },
      { label: "Run CIS benchmark", command: "kube-bench run --targets node,master 2>&1 | head -60", lang: "bash" },
      { label: "Check network policies", command: "kubectl get networkpolicies -A", lang: "bash" },
    ],
    commonVulnerabilities: [
      "RBAC wildcard permissions (*/*/*) on cluster-admin binding",
      "Default service accounts with excessive permissions",
      "Containers running as root without security contexts",
      "Missing network policies (allow all east-west traffic)",
      "etcd not encrypted at rest or exposed without TLS",
      "Kubernetes API server exposed to the internet",
    ],
    hardeningTips: [
      "Apply principle of least privilege to all RBAC roles",
      "Enable Pod Security Standards: enforce baseline or restricted",
      "Apply NetworkPolicy to deny all traffic by default",
      "Enable audit logging on the API server",
      "Use admission controllers: OPA Gatekeeper or Kyverno",
      "Rotate all secrets and service account tokens regularly",
    ],
    relatedCves: ["CVE-2024-21626"],
    tags: ["kubernetes", "k8s", "rbac", "security", "container"],
  },
  {
    slug: "postgres",
    name: "PostgreSQL",
    description: "PostgreSQL database security checks, privilege audit, and hardening guides.",
    category: "database",
    checkCommands: [
      { label: "Check PostgreSQL version", command: "psql -c 'SELECT version();'", lang: "bash" },
      { label: "Audit user privileges", command: "psql -c '\\du'", lang: "bash" },
      { label: "Check pg_hba.conf", command: "cat /etc/postgresql/*/main/pg_hba.conf | grep -v '^#' | grep -v '^$'", lang: "bash" },
      { label: "Check listening interfaces", command: "psql -c 'SHOW listen_addresses;'", lang: "bash" },
      { label: "Check SSL status", command: "psql -c 'SHOW ssl;'", lang: "bash" },
    ],
    commonVulnerabilities: [
      "PostgreSQL listening on all interfaces (0.0.0.0)",
      "Default postgres superuser without strong password",
      "No SSL/TLS for client connections",
      "Overly permissive pg_hba.conf (trust auth for network connections)",
      "Unused extensions with elevated privileges (pg_cron, etc.)",
      "Unencrypted data at rest",
    ],
    hardeningTips: [
      "Set listen_addresses = 'localhost' or internal IP only",
      "Enforce SSL: ssl = on, ssl_min_protocol_version = TLSv1.2",
      "Use scram-sha-256 in pg_hba.conf instead of md5 or trust",
      "Create dedicated app users with minimal privileges (not superuser)",
      "Enable pg_audit for comprehensive audit logging",
      "Rotate database passwords regularly and store in Vault/Secret Manager",
    ],
    relatedCves: ["CVE-2024-56374"],
    tags: ["postgres", "postgresql", "database", "security"],
  },
  {
    slug: "redis",
    name: "Redis",
    description: "Redis security check and hardening tools for production deployments.",
    category: "database",
    checkCommands: [
      { label: "Check Redis version", command: "redis-cli info server | grep redis_version", lang: "bash" },
      { label: "Check bind addresses", command: "redis-cli config get bind", lang: "bash" },
      { label: "Check authentication", command: "redis-cli config get requirepass", lang: "bash" },
      { label: "Check protected mode", command: "redis-cli config get protected-mode", lang: "bash" },
      { label: "Check TLS status", command: "redis-cli config get tls-port", lang: "bash" },
    ],
    commonVulnerabilities: [
      "Redis exposed on public interface without authentication",
      "No requirepass set (unauthenticated access)",
      "Protected mode disabled",
      "KEYS command enabled (performance DoS risk)",
      "CONFIG command accessible by untrusted clients",
      "No TLS encryption for client connections",
    ],
    hardeningTips: [
      "Bind Redis to 127.0.0.1 or private network interface only",
      "Set requirepass with a strong random password",
      "Enable protected-mode yes",
      "Disable dangerous commands: rename-command CONFIG ''",
      "Enable TLS for all client connections (Redis 6.0+)",
      "Use Redis ACLs to restrict command access per user",
    ],
    relatedCves: [],
    tags: ["redis", "database", "cache", "security"],
  },
  {
    slug: "nextjs",
    name: "Next.js",
    description: "Next.js application security checks covering middleware, API routes, and environment variable leaks.",
    category: "web-server",
    checkCommands: [
      { label: "Check Next.js version", command: "node -e \"console.log(require('./node_modules/next/package.json').version)\"", lang: "bash" },
      { label: "Audit dependencies", command: "npm audit --audit-level=high", lang: "bash" },
      { label: "Check NEXT_PUBLIC vars for secrets", command: "grep -r 'NEXT_PUBLIC_' .env* --include='*.ts' --include='*.tsx' | grep -iE 'key|secret|token|pass'", lang: "bash" },
      { label: "Check middleware.ts exists", command: "ls middleware.ts middleware.js 2>/dev/null && echo 'middleware found' || echo 'no middleware'", lang: "bash" },
      { label: "Check security headers", command: "curl -sI https://your-domain | grep -iE 'strict-transport|x-frame|content-security|x-content'", lang: "bash" },
    ],
    commonVulnerabilities: [
      "Middleware authorization bypass (CVE-2025-29927)",
      "NEXT_PUBLIC_ environment variables exposing secrets",
      "Missing security headers in next.config.js",
      "Server Actions without CSRF protection",
      "API routes with insufficient authentication",
      "Outdated Next.js version with known vulnerabilities",
    ],
    hardeningTips: [
      "Keep Next.js updated to the latest patched version",
      "Never prefix secrets with NEXT_PUBLIC_ – only use in server components",
      "Add security headers in next.config.js (CSP, HSTS, X-Frame-Options)",
      "Verify auth in route handlers/server components, not only in middleware",
      "Use next/headers cookies() with httpOnly, sameSite=strict flags",
      "Run npm audit regularly and fix high/critical vulnerabilities",
    ],
    relatedCves: ["CVE-2025-29927"],
    tags: ["nextjs", "react", "web-app", "security"],
  },
  {
    slug: "cloudflare",
    name: "Cloudflare",
    description: "Cloudflare WAF, DDoS protection, and security configuration check tools.",
    category: "network",
    checkCommands: [
      { label: "Check DNS records", command: "dig your-domain.com any +short", lang: "bash" },
      { label: "Check Cloudflare IP ranges", command: "curl -s https://www.cloudflare.com/ips-v4", lang: "bash" },
      { label: "Check SSL mode", command: "curl -sI https://your-domain.com | grep -iE 'cf-ray|cf-cache-status'", lang: "bash" },
      { label: "Check security headers via Cloudflare", command: "curl -sI https://your-domain.com | grep -iE 'strict-transport|x-frame|content-security'", lang: "bash" },
    ],
    commonVulnerabilities: [
      "Origin IP exposed (bypasses Cloudflare WAF)",
      "SSL mode set to 'Flexible' (MITM attack risk)",
      "WAF in 'monitor' mode instead of 'block'",
      "Bot fight mode disabled",
      "No rate limiting rules on login/API endpoints",
      "DNSSEC not enabled",
    ],
    hardeningTips: [
      "Set Cloudflare SSL/TLS mode to 'Full (strict)'",
      "Hide origin IP – ensure origin server only accepts Cloudflare IP ranges",
      "Enable WAF in block mode with OWASP Core Ruleset",
      "Configure rate limiting rules for /login, /api/* endpoints",
      "Enable Bot Fight Mode or Super Bot Fight Mode",
      "Enable DNSSEC for your domain",
    ],
    relatedCves: ["CVE-2023-44487"],
    tags: ["cloudflare", "waf", "ddos", "dns", "security"],
  },
]

/** Get a ServiceCheckEntry by slug */
export function getServiceCheck(slug: string): ServiceCheckEntry | null {
  const normalized = slug.toLowerCase().replace(/^check-/, "")
  return SERVICE_CHECKS.find((s) => s.slug === normalized) ?? buildFallbackServiceCheck(normalized)
}

/** Build a deterministic fallback ServiceCheckEntry for any service slug */
export function buildFallbackServiceCheck(slug: string): ServiceCheckEntry {
  const name = slug
    .replace(/-/g, " ")
    .replace(/\b\w/g, (c) => c.toUpperCase())

  return {
    slug,
    name,
    description: `Security check and hardening tools for ${name} deployments. Audit, harden, and verify your ${name} configuration.`,
    category: "other",
    checkCommands: [
      { label: `Check ${name} version`, command: `${slug} --version 2>/dev/null || ${slug} version 2>/dev/null || echo "Check vendor docs for version command"`, lang: "bash" },
      { label: "Audit dependencies", command: "# Check for known CVEs in your package manager:\n# npm audit / pip-audit / trivy fs .", lang: "bash" },
      { label: "Check network exposure", command: `ss -tlnp | grep -i ${slug}`, lang: "bash" },
      { label: "Check process status", command: `systemctl status ${slug} 2>/dev/null || ${slug} status 2>/dev/null`, lang: "bash" },
    ],
    commonVulnerabilities: [
      "Outdated version with unpatched CVEs",
      "Default credentials not changed",
      "Service exposed on public interface unnecessarily",
      "Missing authentication or weak authentication",
      "No TLS/encryption for connections",
      "Excessive permissions or running as root",
    ],
    hardeningTips: [
      `Keep ${name} updated to the latest stable release`,
      "Change all default credentials immediately after installation",
      "Restrict network access: bind to localhost or private network only",
      "Enable TLS encryption for all connections",
      "Apply principle of least privilege: run service with dedicated non-root user",
      "Enable audit logging and set up alerts for security events",
    ],
    relatedCves: [],
    tags: [slug, "security", "hardening"],
  }
}
