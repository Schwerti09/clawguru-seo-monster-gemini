// WORLD BEAST: app/api/agents/vulnerability/route.ts
// Daily CVE scanner agent â€“ scans for new vulnerabilities and builds runbooks.
// Secured by CRON_SECRET.

import { NextRequest, NextResponse } from "next/server"
import { runVulnerabilityHunter } from "@/lib/agents"
import { postToDiscord } from "@/lib/discord"

export const dynamic = "force-dynamic"
export const runtime = "nodejs"

export async function GET(req: NextRequest) {
  const secret = process.env.CRON_SECRET
  if (secret) {
    const auth = req.headers.get("authorization") ?? ""
    const param = req.nextUrl.searchParams.get("secret") ?? ""
    if (auth !== `Bearer ${secret}` && param !== secret) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
    }
  }

  try {
    const result = await runVulnerabilityHunter()

    // WORLD BEAST: post new CVE runbooks to Discord
    if (result.runbooksCreated.length > 0) {
      const top = result.runbooksCreated[0]
      await postToDiscord(
        `ðŸ¦  **Vulnerability Hunter** found ${result.runbooksCreated.length} new CVE runbook(s)!\n` +
        `Latest: **${top.title}** (${top.cveId}) â€“ Severity: \`${top.severity}\`\n` +
        `https://clawguru.org/runbook/${top.slug}`
      ).catch(() => undefined)
    }

    return NextResponse.json(result, {
      headers: { "Cache-Control": "no-store" },
    })
  } catch (err) {
    const message = err instanceof Error ? err.message : String(err)
    return NextResponse.json({ ok: false, error: message }, { status: 500 })
  }
}
